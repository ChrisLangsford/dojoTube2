AmCharts.AmExport=AmCharts.Class({construct:function(t,e,r){var o=this;o.DEBUG=!1,o.chart=t,o.canvas=null,o.svgs=[],o.userCFG=e,o.buttonIcon="export.png",o.exportPNG=!0,o.exportPDF=!1,o.exportJPG=!1,o.exportSVG=!1,o.right=0,o.top=0,o.buttonRollOverColor="#EFEFEF",o.textRollOverColor="#CC0000",o.buttonTitle="Save chart as an image",o.buttonAlpha=.75,o.imageFileName="amChart",o.imageBackgroundColor="#FFFFFF",r&&o.init()},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var r=[];if(1==e.length){var o=e[0];r.push({format:o,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(e.length>1){for(var a=[],n=0;n<e.length;n++)a.push({format:e[n],title:e[n].toUpperCase()});r.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:a})}var i=t.color;void 0===i&&(i=t.chart.color);var s=t.buttonColor;void 0===s&&(s="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:r,menuItemStyle:{backgroundColor:s,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(e,r,o){o.preventDefault(),t.chart.prepareForExport&&t.chart.prepareForExport(),e.output(r)}},removeImagery:!0},t.processing={buffer:[],drawn:0,timer:0},"undefined"!=typeof window.canvg&&"undefined"!=typeof window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),"undefined"!=typeof window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var u=t.userCFG;u&&(u.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,u.menuItemOutput||{}),u.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,u.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,u)),t.chart.AmExport=t,t.chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var t=this;10==t.DEBUG&&t.log("SETUP START"),!AmCharts.isIE||AmCharts.isIE&&AmCharts.IEversion>9?(t.generateButtons(),10==t.DEBUG&&t.log("SETUP END")):10==t.DEBUG&&t.log("< IE10 NOT SUPPORTED")},generateBinaryArray:function(t){for(var e,r,o,a=t.length,n=new Uint8Array(a/4*3|0),i=0,s=0,u=[0,0],l=0,g=0,d=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);a--;)r=t.charCodeAt(i++),e=d[r-43],255!==e&&e!==o&&(u[1]=u[0],u[0]=r,g=g<<6|e,l++,4===l&&(n[s++]=g>>>16,61!==u[1]&&(n[s++]=g>>>8),61!==u[0]&&(n[s++]=g),l=0));return n},generateBlob:function(t,e){var r=this,o="image/svg+xml"!=e?t.indexOf(",")+1:0,a=t.substring(0,o),n=t,i=new Blob;return-1!=a.indexOf("base64")&&(n=r.generateBinaryArray(t.substring(o))),AmCharts.isIE&&AmCharts.IEversion<10?(i.data=n,i.size=n.length,i.type=e,i.encoding="base64"):i=new Blob([n],{type:e}),i},generatePDF:function(t){var e=this,r={output:function(){return""}},o=e.canvas.toDataURL("image/jpeg"),a=25.4*e.canvas.width/t.dpi,n=25.4*e.canvas.height/t.dpi;return window.jsPDF?(r=new jsPDF,r.addImage?r.addImage(o,"JPEG",0,0,a,n):alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),r},output:function(t,e){function r(){var r,a=null;10==o.DEBUG&&o.log("OUTPUT",t.format),"image/svg+xml"==t.format||"svg"==t.format?(a=o.generateSVG(),r=o.generateBlob(a,"image/svg+xml"),"save"==t.output?saveAs(r,t.fileName+".svg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r="data:image/svg+xml;base64,"+btoa(a):"dataurlnewwindow"==t.output?window.open("data:image/svg+xml;base64,"+btoa(a)):"datauri"==t.output||"dataurl"==t.output?location.href="data:image/svg+xml;base64,"+btoa(a):"datastream"==t.output&&(location.href="data:image/octet-stream;base64,"+a),e&&e.apply(o,[r])):"application/pdf"==t.format||"pdf"==t.format?(a=o.generatePDF(t).output("dataurlstring"),r=o.generateBlob(a,"application/pdf"),"save"==t.output?saveAs(r,t.fileName+".pdf"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=a:"dataurlnewwindow"==t.output?window.open(a):"datauri"==t.output||"dataurl"==t.output?location.href=a:"datastream"==t.output&&(location.href=a.replace("application/pdf","application/octet-stream")),e&&e.apply(o,[r])):"image/png"==t.format||"png"==t.format?(a=o.canvas.toDataURL("image/png"),r=o.generateBlob(a,"image/png"),"save"==t.output?saveAs(r,t.fileName+".png"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=a:"dataurlnewwindow"==t.output?window.open(a):"datauri"==t.output||"dataurl"==t.output?location.href=a:"datastream"==t.output&&(location.href=a.replace("image/png","image/octet-stream")),e&&e.apply(o,[r])):("image/jpeg"==t.format||"jpeg"==t.format||"jpg"==t.format)&&(a=o.canvas.toDataURL("image/jpeg"),r=o.generateBlob(a,"image/jpeg"),"save"==t.output?saveAs(r,t.fileName+".jpg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=a:"dataurlnewwindow"==t.output?window.open(a):"datauri"==t.output||"dataurl"==t.output?location.href=a:"datastream"==t.output&&(location.href=a.replace("image/jpeg","image/octet-stream")),e&&e.apply(o,[r]))}var o=this;return t=AmCharts.extend(AmCharts.extend({},o.cfg.menuItemOutput),t||{}),o.generateOutput(t,r)},polifySVG:function(t){function e(t,e){for(var o=t.getElementsByTagName(e),a=o.length;a--;){if(r.cfg.removeImagery)o[a].parentNode.removeChild(o[a]);else{var n=document.createElement("img"),i=document.createElement("canvas"),s=i.getContext("2d");i.width=o[a].getAttribute("width"),i.height=o[a].getAttribute("height"),n.src=o[a].getAttribute("xlink:href"),n.width=o[a].getAttribute("width"),n.height=o[a].getAttribute("height");try{s.drawImage(n,0,0,n.width,n.height),datastring=i.toDataURL()}catch(u){throw datastring=n.src,r.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(u)}o[a].setAttribute("xlink:href",datastring)}10==r.DEBUG&&r.log("POLIFIED",o[a])}}var r=this;return 0==AmCharts.IEversion&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),r.cfg.removeImagery||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),10==r.DEBUG&&r.log("POLIFIED",t),e(t,"pattern"),e(t,"image"),r.svgs.push(t),t},generateSVG:function(){var t=this,e=document.createElement("svg");e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var r=0;r<t.processing.buffer.length;r++){var o=document.createElement("g"),a=t.processing.buffer[r];a[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),a[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),o.setAttribute("transform","translate("+a[1].x+","+a[1].y+")"),o.appendChild(a[0]),e.appendChild(o)}return(new XMLSerializer).serializeToString(e)},generateOutput:function(t,e){function r(){var a,s,u,l;return o.processing.buffer.length==o.processing.drawn||"svg"==t.format?(10==o.DEBUG&&o.log("END DRAWING"),e()):(10==o.DEBUG&&o.log("DRAW",o.processing.drawn+1,"OF",o.processing.buffer.length),s=o.processing.buffer[o.processing.drawn],l=(new XMLSerializer).serializeToString(s[0]),u=s[1],10==o.DEBUG&&o.log("SOURCE",l),"browser"==t.render?(a=new Image,a.id=AmCharts.getUniqueId(),l="data:image/svg+xml;base64,"+btoa(l),a.onload=function(){i.drawImage(this,s[1].x,s[1].y),o.processing.drawn++,10==o.DEBUG&&o.log("ONLOAD",this),r()},a.onerror=function(){10==o.DEBUG&&o.log("ONERROR",this),i.drawImage(this,s[1].x,s[1].y),o.processing.drawn++,r()},a.src=l,10==o.DEBUG&&o.log("ADD",a),(a.complete||"undefined"==typeof a.complete||void 0===a.complete)&&(10==o.DEBUG&&o.log("FORCE ONLOAD",a),a.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a.src=l)):"canvg"==t.render&&canvg(n,l,{offsetX:u.x,offsetY:u.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){o.processing.drawn++,r()}}),void 0)}var o=this,a=o.chart.div.getElementsByTagName("svg"),n=document.createElement("canvas"),i=n.getContext("2d"),s={y:0,x:0},u={};o.processing.buffer=[],o.processing.drawn=0,o.canvas=n,o.svgs=[],10==o.DEBUG&&o.log("START EXPORT"),10==o.DEBUG&&o.log("START BUFFERING");for(var l=0;l<a.length;l++){var g=a[l].parentNode,d=Number(g.style.left.slice(0,-2)),p=Number(g.style.top.slice(0,-2)),m=o.polifySVG(a[l].cloneNode(!0)),u=AmCharts.extend({},s);"relative"==g.style.position?(s.x=d?d:s.x,s.y=p?p:s.y):(s.x=d,s.y=p),o.processing.buffer.push([m,AmCharts.extend({},s)]),p&&d?s=u:s.y+=p?0:g.offsetHeight,10==o.DEBUG&&o.log("BUFFERED",a[l],s)}10==o.DEBUG&&o.log("END BUFFERING"),10==o.DEBUG&&o.log("START DRAWING",t.render),10==o.DEBUG&&o.log("FILL BACKGROUND"),n.id=AmCharts.getUniqueId(),n.width=o.chart.divRealWidth,n.height=o.chart.divRealHeight;var c={width:!1,height:!1};return o.chart.periodSelector&&(-1!=["left","right"].indexOf(o.chart.periodSelector.position)?(n.width-=o.chart.periodSelector.div.offsetWidth+16,c.width=!0):(n.height-=o.chart.periodSelector.div.offsetHeight,c.height=!0)),o.chart.dataSetSelector&&(-1!=["left","right"].indexOf(o.chart.dataSetSelector.position)?c.width||(n.width-=o.chart.dataSetSelector.div.offsetWidth+16):n.height-=o.chart.dataSetSelector.div.offsetHeight),(t.backgroundColor||"image/jpeg"==t.format)&&(i.fillStyle=t.backgroundColor||"#FFFFFF",i.fillRect(0,0,n.width,n.height)),r()},generateButtons:function(){function t(r){var a=document.createElement("ul");a.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var n=0;n<r.length;n++){var i=document.createElement("li"),s=document.createElement("img"),u=document.createElement("a"),l=r[n],g=null,d=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemStyle),r[n]);l=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemOutput),l),l.icon&&(s.alt="",s.src=l.icon,s.setAttribute("style","margin: 0 auto;border: none;outline: none"),l.iconTitle&&(s.title=l.iconTitle),u.appendChild(s)),u.href="#",l.title&&(s.setAttribute("style","margin-right: 5px;"),u.innerHTML+=l.title),u.setAttribute("style","display: block;"),AmCharts.extend(u.style,d),u.onclick=l.onclick.bind(u,e,l),i.appendChild(u),l.items&&(g=t(l.items),i.appendChild(g),i.onmouseover=function(){g.style.display="block"},i.onmouseout=function(){g.style.display="none"},g.style.display="none"),a.appendChild(i),u.onmouseover=function(){this.style.backgroundColor=d.rollOverBackgroundColor,this.style.color=d.rollOverColor,this.style.borderColor=d.rollOverBorderColor},u.onmouseout=function(){this.style.backgroundColor=d.backgroundColor,this.style.color=d.color,this.style.borderColor=d.borderColor}}return o++,10==e.DEBUG&&e.log("MENU",a),a}var e=this,r=document.createElement("div"),o=0;r.setAttribute("style","width:39px; height:28px; position: absolute;top:"+e.cfg.menuTop+";right:"+e.cfg.menuRight+";bottom:"+e.cfg.menuBottom+";left:"+e.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);"),r.setAttribute("class","amExportButton"),r.appendChild(t(e.cfg.menuItems)),e.chart.containerDiv.appendChild(r)}});